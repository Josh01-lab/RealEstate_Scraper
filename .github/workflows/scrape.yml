name: Nightly scrape (Lamudi Cebu)

on:
  schedule:
    - cron: "0 19 * * *" # 16:00 UTC = 3:00 a.m PH (+8). Adjust as you like.
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system deps for Playwright
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libatk-bridge2.0-0 libxkbcommon0 libgtk-3-0 libdrm2 libgbm1

      - name: Install Python deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Set env
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "SUPABASE_URL set"
          echo "SUPABASE_SERVICE_ROLE_KEY set"

      - name: Run discovery
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          MAX_PAGES: "1"
          SCRAPING_MODE: "playwright"
        run: |
          python -m src.runner.run_discovery --portal lamudi_cebu

      - name: Capture run dir
        id: rundir
        run: |
          echo "dir=$(ls -1d scraper_output/run_* | tail -n1)" >> $GITHUB_OUTPUT

      - name: Details
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SCRAPING_MODE: "playwright"
        run: |
          python -m src.runner.run_details --portal lamudi_cebu --run-dir "${{ steps.rundir.outputs.dir }}"

      - name: Publish to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python -m src.runner.write_portal_dump_to_supabase --portal lamudi_cebu --run-dir "${{ steps.rundir.outputs.dir }}"
